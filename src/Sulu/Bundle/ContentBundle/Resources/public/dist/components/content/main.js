define(["sulucontent/model/content","sulucontent/components/content/preview/main","sulucontent/components/copy-locale-overlay/main","sulusecurity/services/security-checker","config"],function(a,b,c,d,e){"use strict";var f="contentLanguage",g="column-navigation-show-ghost-pages",h=1,i={localizationUrl:"/admin/api/webspace/localizations",previewExpandIcon:"fa-step-backward",previewCollapseIcon:"fa-step-forward"},j={0:"stateTest",1:"stateTest",2:"statePublish"},k={preview:['<div class="sulu-content-preview auto">','   <div class="preview-toolbar">','       <div class="'+i.previewExpandIcon+' toggler"></div>','       <div class="toolbar"></div>','       <div class="fa-external-link new-window"></div>',"   </div>",'   <div class="container">','       <div class="wrapper">','           <div class="viewport">','               <iframe src="<%= url %>"></iframe>',"           </div>","       </div>","   </div>","</div>"].join(""),previewOnRequest:['<div class="v-center">','   <div id="preview-start" class="btn grey large">','       <span class="fa-play"></span>','       <span class="text"><%= startLabel %></span>',"   </div>","</div>"].join(""),previewUrl:"<%= url %><%= uuid %>/render?webspace=<%= webspace %>&language=<%= language %>"},l=function(a){return"/"===a.url};return{initialize:function(){this.saved=!0,this.previewUrl=null,this.previewWindow=null,this.previewExpanded=!1,this.$preview=null,this.previewMode=e.get("sulu.content.preview").mode,this.preview=new b,this.preview.initialize(this.sandbox,this.options,this.$el),"column"===this.options.display?this.renderColumn():this.render(),this.bindCustomEvents()},loadComponentData:function(){var a=$.Deferred(),b=$.Deferred();return this.loadLocalizations().then(function(){a.resolve()}.bind(this)),"column"!==this.options.display?this.loadData().then(function(){b.resolve()}.bind(this)):b.resolve(),$.when(a,b)},renderColumn:function(){var a=this.sandbox.dom.createElement('<div id="content-column-container"/>');this.sandbox.dom.append(this.$el,a),this.sandbox.start([{name:"content/column@sulucontent",options:{el:a,webspace:this.options.webspace,language:this.options.language}}])},loadLocalizations:function(){return this.sandbox.util.load(i.localizationUrl+"?webspace="+this.options.webspace).then(function(a){this.localizations=a._embedded.localizations.map(function(a){return{id:a.localization,title:a.localization}})}.bind(this))},loadData:function(){var b=$.Deferred();return this.content||(this.content=new a({id:this.options.id})),void 0!==this.options.id?this.content.fullFetch(this.options.webspace,this.options.language,!0,{success:function(a){this.data=a.toJSON(),b.resolve()}.bind(this)}):(this.data=this.content.toJSON(),b.resolve()),b},bindCustomEvents:function(){this.sandbox.on("sulu.header.back",function(){this.sandbox.emit("sulu.content.contents.list")}.bind(this)),this.sandbox.on("sulu.content.contents.list",function(a,b){var c="content/contents/"+(a?a:this.options.webspace)+"/"+(b?b:this.options.language);this.sandbox.emit("sulu.app.ui.reset",{navigation:"auto",content:"auto"}),this.sandbox.emit("sulu.router.navigate",c)},this),this.sandbox.on("sulu.content.contents.get-data",function(a){a(JSON.parse(JSON.stringify(this.data)))}.bind(this)),this.sandbox.on("sulu.content.contents.set-header-bar",function(a){this.setHeaderBar(a)}.bind(this)),this.sandbox.on("sulu.content.contents.set-state",function(a){this.setState(a)}.bind(this)),this.sandbox.on("sulu.header.language-changed",function(a){if(this.sandbox.sulu.saveUserSetting(f,a.id),"column"!==this.options.display){var b=this.content.toJSON();b.id?this.sandbox.emit("sulu.content.contents.load",b,this.options.webspace,a.id):this.add(this.options.parent?{id:this.options.parent}:null,this.options.webspace,a.id)}else this.sandbox.emit("sulu.content.contents.list",this.options.webspace,a.id)},this),this.sandbox.on("husky.tabs.header.item.select",function(a){"tab-excerpt"===a.id&&(this.template=this.data.originTemplate)}.bind(this)),this.sandbox.on("sulu.dropdown.template.item-clicked",function(){this.setHeaderBar(!1)}.bind(this)),this.sandbox.on("sulu.content.contents.saved",function(a,b){this.data=b,this.setHeaderBar(!0),this.sandbox.dom.html('li[data-id="'+this.options.language+'"] a',this.options.language),this.sandbox.emit("sulu.labels.success.show","labels.success.content-save-desc","labels.success")},this),this.sandbox.on("sulu.content.contents.save-error",function(){this.sandbox.emit("sulu.labels.error.show","labels.error.content-save-desc","labels.error"),this.setHeaderBar(!1)},this),this.sandbox.on("sulu.preview.delete",function(){this.sandbox.emit("sulu.content.content.delete",this.data.id)},this),this.sandbox.on("sulu.content.contents.default-template",function(a){this.template=a,this.data.nodeType!==h&&(this.sandbox.emit("sulu.header.toolbar.item.change","template",a),this.hiddenTemplate&&(this.hiddenTemplate=!1,this.sandbox.emit("sulu.header.toolbar.item.show","template",a)))},this),this.sandbox.on("husky.navigation.item.select",function(a){a.id!==this.options.id&&this.sandbox.emit("sulu.app.ui.reset",{navigation:"auto",content:"auto"})}.bind(this)),this.sandbox.on("sulu.header.state.changed",function(a){this.state!==a&&(this.state=a,this.setHeaderBar(!1))}.bind(this)),this.sandbox.on("sulu.content.preview.change-url",this.changePreviewUrl.bind(this)),this.sandbox.on("sulu.permission-tab.saved",function(a,b){this.afterSaveAction(b,!1)}.bind(this)),this.bindModelEvents()},bindModelEvents:function(){this.sandbox.on("sulu.content.content.delete",function(a){this.del(a)},this),this.sandbox.on("sulu.content.contents.save",function(a,b){this.save(a,b).then(function(){this.loadData()}.bind(this))},this),this.sandbox.on("sulu.content.contents.load",function(a,b,c){this.load(a,b,c)},this),this.sandbox.on("sulu.content.contents.new",function(a){this.add(a)},this),this.sandbox.on("sulu.content.contents.delete",function(a){this.delContents(a)},this),this.sandbox.on("sulu.content.contents.move",this.move,this),this.sandbox.on("sulu.content.contents.copy",this.copy,this),this.sandbox.on("sulu.content.contents.copy-locale",c.copyLocale,this),this.sandbox.on("sulu.content.contents.order",this.order,this),this.sandbox.once("sulu.content.contents.get-rl",function(a,b){this.getResourceLocator(a,this.template,b)},this),this.sandbox.on("sulu.content.contents.list",function(a,b){var c="content/contents/"+(a?a:this.options.webspace)+"/"+(b?b:this.options.language);this.sandbox.emit("sulu.app.ui.reset",{navigation:"auto",content:"auto"}),this.sandbox.emit("sulu.router.navigate",c)},this)},getResourceLocator:function(a,b,c){var d="/admin/api/nodes/resourcelocators/generates?"+(this.options.parent?"parent="+this.options.parent+"&":"")+(this.options.id?"uuid="+this.options.id+"&":"")+"&webspace="+this.options.webspace+"&language="+this.options.language+"&template="+b;this.sandbox.util.save(d,"POST",{parts:a}).then(function(a){c(a.resourceLocator)})},move:function(a,b,c,d){var e=["/admin/api/nodes/",a,"?webspace=",this.options.webspace,"&language=",this.options.language,"&action=move&destination=",b].join("");this.sandbox.util.save(e,"POST",{}).then(function(a){c&&"function"==typeof c&&c(a)}.bind(this)).fail(function(a,b,c){d&&"function"==typeof d&&d(c)}.bind(this))},copy:function(a,b,c,d){var e=["/admin/api/nodes/",a,"?webspace=",this.options.webspace,"&language=",this.options.language,"&action=copy&destination=",b].join("");this.sandbox.util.save(e,"POST",{}).then(function(a){c&&"function"==typeof c&&c(a)}.bind(this)).fail(function(a,b,c){d&&"function"==typeof d&&d(c)}.bind(this))},order:function(a,b,c,d){var e=["/admin/api/nodes/",a,"?webspace=",this.options.webspace,"&language=",this.options.language,"&action=order"].join("");this.sandbox.util.save(e,"POST",{position:b}).then(function(a){c&&"function"==typeof c&&c(a)}.bind(this)).fail(function(a,b,c){d&&"function"==typeof d&&d(c)}.bind(this))},del:function(b){this.sandbox.sulu.showDeleteDialog(function(c){if(c)if(this.sandbox.emit("sulu.header.toolbar.item.loading","settings"),this.content&&b===this.content.get("id"))this.content.fullDestroy(this.options.webspace,this.options.language,{processData:!0,success:function(){var a="content/contents/"+this.options.webspace+"/"+this.options.language;this.sandbox.emit("sulu.app.ui.reset",{navigation:"auto",content:"auto"}),this.sandbox.sulu.unlockDeleteSuccessLabel(),this.sandbox.emit("sulu.router.navigate",a),this.sandbox.emit("sulu.preview.deleted",b)}.bind(this)});else{var d=new a({id:b});d.fullDestroy(this.options.webspace,this.options.language,{processData:!0,success:function(){var a="content/contents/"+this.options.webspace+"/"+this.options.language;this.sandbox.emit("sulu.router.navigate",a),this.sandbox.emit("sulu.preview.deleted",b)}.bind(this)})}}.bind(this))},delContents:function(b){this.confirmDeleteDialog(function(c){c&&b.forEach(function(b){var c=new a({id:b});c.fullDestroy(this.options.webspace,this.options.language,{success:function(){this.sandbox.emit("husky.datagrid.record.remove",b)}.bind(this),error:function(){}})}.bind(this))}.bind(this))},changeState:function(a){this.sandbox.emit("sulu.content.contents.state.change"),this.content.stateSave(this.options.webspace,this.options.language,a,null,{success:function(){this.sandbox.emit("sulu.content.contents.state.changed",a),this.sandbox.emit("sulu.labels.success.show","labels.state-changed.success-desc","labels.success","sulu.content.contents.state.label")}.bind(this),error:function(){this.sandbox.emit("sulu.content.contents.state.changeFailed"),this.sandbox.emit("sulu.labels.error.show","labels.state-changed.error-desc","labels.error","sulu.content.contents.state.label"),this.sandbox.logger.log("error while saving profile")}.bind(this)})},save:function(b,c){this.sandbox.emit("sulu.header.toolbar.item.loading","save");var d=this.sandbox.data.deferred();return this.content?this.content.set(b):this.content=new a(b),this.options.id&&this.content.set({id:this.options.id}),this.content.fullSave(this.template,this.options.webspace,this.options.language,this.options.parent,this.state,l(b)?"home":null,null,{success:function(a){var b=a.toJSON();this.options.id?this.sandbox.emit("sulu.content.contents.saved",b.id,b):this.sandbox.sulu.viewStates.justSaved=!0,this.afterSaveAction(c,!this.options.id),d.resolve()}.bind(this),error:function(){this.sandbox.logger.log("error while saving profile"),this.sandbox.emit("sulu.header.toolbar.item.enable","save"),this.sandbox.emit("sulu.content.contents.save-error")}.bind(this)}),d},afterSaveAction:function(a,b){if("back"===a)this.sandbox.emit("sulu.content.contents.list");else if("new"===a){var c,d=this.content.get("breadcrumb");c=(this.options.id&&d.length>1?d[d.length-1].uuid:null)||this.options.parent,this.sandbox.emit("sulu.router.navigate","content/contents/"+this.options.webspace+"/"+this.options.language+"/add"+(c?":"+c:"")+"/content",!0,!0)}else b&&this.sandbox.emit("sulu.router.navigate","content/contents/"+this.options.webspace+"/"+this.options.language+"/edit:"+this.content.get("id")+"/content")},load:function(a,b,c,d){var e="content";(a.nodeType&&a.nodeType!==h||a.type&&a.type.name&&"shadow"===a.type.name)&&(e="settings"),this.sandbox.emit("sulu.router.navigate","content/contents/"+(b?b:this.options.webspace)+"/"+(c?c:this.options.language)+"/edit:"+a.id+"/"+e,void 0,void 0,d)},add:function(a,b,c){a?this.sandbox.emit("sulu.router.navigate","content/contents/"+(b?b:this.options.webspace)+"/"+(c?c:this.options.language)+"/add:"+a.id+"/content"):this.sandbox.emit("sulu.router.navigate","content/contents/"+(b?b:this.options.webspace)+"/"+(c?c:this.options.language)+"/add/content")},render:function(){this.setTemplate(this.data),this.setState(this.data),this.options.preview&&this.data.nodeType===h&&!this.data.shadowOn?(this.sandbox.util.each(["content","excerpt","seo"],function(a,b){this.sandbox.emit("husky.tabs.header.item.show","tab-"+b)}.bind(this)),this.sandbox.on("sulu.preview.initiated",function(){this.renderPreview(this.data)}.bind(this)),this.sandbox.on("sulu.preview.changes",this.handleChanges.bind(this)),this.sandbox.on("sulu.preview.initialize",function(a,b){"auto"===this.previewMode?this.sandbox.emit("sulu.preview.initialize.force",a,b):"on_request"===this.previewMode&&this.renderPreviewOnRequest(b)}.bind(this)),this.sandbox.on("sulu.preview.initialize.force",function(a,b){this.previewInitialize(a,b)}.bind(this))):this.sandbox.emit("sulu.sidebar.hide"),this.options.id&&((this.data.shadowOn===!0||this.data.nodeType!==h)&&this.sandbox.util.each(["content","seo"],function(a,b){this.sandbox.emit("husky.tabs.header.item.hide","tab-"+b)}.bind(this)),this.options.id&&((this.data.shadowOn===!0||this.data.nodeType!==h)&&this.sandbox.util.each(["content","seo"],function(a,b){this.sandbox.emit("husky.tabs.header.item.hide","tab-"+b)}.bind(this)),("settings"!==this.options.content&&this.data.shadowOn===!0||"content"===this.options.content&&this.data.nodeType!==h)&&this.sandbox.emit("sulu.router.navigate","content/contents/"+this.options.webspace+"/"+this.options.language+"/edit:"+this.data.id+"/settings"))),this.setHeaderBar(!0)},previewInitialize:function(a,b){a=this.sandbox.util.extend(!0,{},this.data,a),this.preview.initiated?b&&(this.sandbox.dom.remove(this.$preview),this.$preview=null,this.preview.restart(a,this.options,this.template)):this.preview.start(a,this.options)},renderPreviewOnRequest:function(a){this.sandbox.emit("sulu.sidebar.change-width","max"),this.$preview=this.sandbox.dom.createElement(this.sandbox.util.template(k.previewOnRequest,{startLabel:this.sandbox.translate("content.contents.start-preview")})),this.sandbox.dom.on(this.sandbox.dom.find("#preview-start",this.$preview),"click",function(){this.sandbox.dom.remove(this.$preview),this.$preview=null;var b=this.sandbox.form.getData("#content-form-container");this.sandbox.emit("sulu.preview.initialize.force",b,a)}.bind(this)),this.sandbox.emit("sulu.sidebar.set-widget",null,this.$preview)},renderPreview:function(a){this.sandbox.emit("sulu.sidebar.change-width","max"),null===this.$preview&&(this.previewUrl=this.sandbox.util.template(k.previewUrl,{url:"/admin/content/preview/",webspace:this.options.webspace,language:this.options.language,uuid:a.id}),this.$preview=this.sandbox.dom.createElement(this.sandbox.util.template(k.preview,{url:this.previewUrl})),this.bindPreviewEvents(),this.startPreviewToolbar(),this.sandbox.emit("sulu.sidebar.set-widget",null,this.$preview))},startPreviewToolbar:function(){this.sandbox.start([{name:"toolbar@husky",options:{el:this.$preview.find(".toolbar"),instanceName:"preview",skin:"big",responsive:!0,buttons:this.sandbox.sulu.buttons.get({displayDevices:{},refresh:{}})}}])},bindPreviewEvents:function(){this.$preview.find(".new-window").on("click",this.openPreviewInNewWindow.bind(this)),this.$preview.find(".toggler").on("click",this.togglePreview.bind(this)),this.sandbox.on("sulu.toolbar.refresh",this.refreshPreview.bind(this)),this.sandbox.on("sulu.toolbar.display-device",this.changePreviewStyle.bind(this))},changePreviewUrl:function(a){if(null!==this.$preview&&this.content){var b,c=this.content.toJSON(),d={url:"/admin/content/preview/",webspace:this.options.webspace,language:this.options.language,uuid:c.id,template:c.template};d=this.sandbox.util.extend(!0,{},d,a),this.previewUrl=this.sandbox.util.template(k.previewUrl)(d),b=this.sandbox.dom.find("iframe",this.$preview),this.sandbox.dom.attr(b,"src",this.previewUrl),this.previewWindow&&this.previewWindow.closed===!1&&this.previewWindow.close()}},changePreviewStyle:function(a){null!==this.$preview&&(this.$preview.removeClass(this.$preview.data("sulu-preview-style")),this.$preview.addClass(a),this.$preview.data("sulu-preview-style",a))},togglePreview:function(){this.previewExpanded?(this.sandbox.emit("sulu.app.toggle-column",!1),this.sandbox.dom.removeClass(this.$preview.find(".toggler"),i.previewCollapseIcon),this.sandbox.dom.prependClass(this.$preview.find(".toggler"),i.previewExpandIcon),this.previewExpanded=!1):(this.sandbox.emit("sulu.app.toggle-column",!0),this.previewExpanded=!0,this.sandbox.dom.removeClass(this.$preview.find(".toggler"),i.previewExpandIcon),this.sandbox.dom.prependClass(this.$preview.find(".toggler"),i.previewCollapseIcon))},openPreviewInNewWindow:function(){this.sandbox.emit("sulu.app.change-width","fixed"),this.sandbox.emit("husky.navigation.show"),this.sandbox.emit("sulu.sidebar.hide"),this.previewWindow=window.open(this.previewUrl),this.previewWindow.onload=function(){this.previewWindow.onunload=function(){this.previewWindow=null,this.sandbox.emit("sulu.sidebar.show"),this.sandbox.emit("sulu.sidebar.change-width","max")}.bind(this)}.bind(this)},refreshPreview:function(){this.getPreviewDocument().location.reload()},setTemplate:function(a){this.template=a.originTemplate,this.data.nodeType===h&&""!==this.template&&void 0!==this.template&&null!==this.template&&(this.sandbox.emit("sulu.header.toolbar.item.change","template",this.template),this.sandbox.emit("sulu.header.toolbar.item.show","template"))},setState:function(a){this.state=a.nodeState,""!==this.state&&void 0!==this.state&&null!==this.state&&this.sandbox.emit("sulu.header.toolbar.item.change","state",j[this.state])},setHeaderBar:function(a){a!==this.saved&&(a===!0?this.sandbox.emit("sulu.header.toolbar.item.disable","save",!0):this.sandbox.emit("sulu.header.toolbar.item.enable","save",!1),this.sandbox.emit("sulu.preview.state.change",a)),this.saved=a},getPreviewDocument:function(){return this.previewWindow?this.previewWindow.document:this.sandbox.dom.find("iframe",this.$preview).contents()[0]},handleChanges:function(a){if(a.reload)this.getPreviewDocument().location.reload();else for(var b in a)a.hasOwnProperty(b)&&(-1!==b.indexOf(",")?this.handleSequence(b,a[b]):this.handleSingle(b,a[b]))},handleSequence:function(a,b){var c,d=a.split(","),e="",f=0,g=/^\d*$/;for(c in d)g.test(d[c])?e+=' *[rel="'+f+'"]:nth-child('+(parseInt(d[c])+1)+")":(f=d[c],e+=' *[property="'+d[c]+'"]');this.handle(b,e,function(){return!0})},handleSingle:function(a,b){var c='*[property="'+a+'"]';this.handle(b,c,function(a){for(var b=a.parentNode;null!==b.parentNode;){if(b.hasAttribute("property"))return!1;b=b.parentNode}return!0})},handle:function(a,b,c){var d=0,e=this.getPreviewDocument().querySelectorAll(b),f=[].slice.call(e);f.forEach(function(b){c(b)&&(b.innerHTML="undefined"!=typeof a[d]?a[d]:"",d++)})},getCopyLocaleUrl:function(a,b,c){return["/admin/api/nodes/",a,"?webspace=",this.options.webspace,"&language=",b,"&dest=",c,"&action=copy-locale"].join("")},header:function(){var a,b,e,f=[],h=[],i=[];if("column"===this.options.display){var j=this.sandbox.sulu.getUserSetting(g),k=JSON.parse(j)?"toggler-on":"toggler",m={};m[k]={options:{title:"content.contents.show-ghost-pages"}},b={noBack:!0,toolbar:{buttons:m,languageChanger:{data:this.localizations,preSelected:this.options.language}}}}else{for(var n in this.data.concreteLanguages)this.data.concreteLanguages.hasOwnProperty(n)&&f.push(this.data.concreteLanguages[n]);for(n=0,a=this.localizations.length;a>n;n++)h[n]={id:this.localizations[n].id,title:this.localizations[n].title},f.indexOf(this.localizations[n].id)<0&&(h[n].title+=[" (",this.sandbox.translate("content.contents.new"),")"].join(""));e="/admin/content-navigations",i.push("alias=content"),this.data.id&&i.push("id="+this.data.id),this.options.webspace&&i.push("webspace="+this.options.webspace),i.length&&(e+="?"+i.join("&"));var o={},p={};d.hasPermission(this.data,"edit")&&(o.save={parent:"saveWithOptions"},o.template={options:{dropdownOptions:{url:"/admin/content/template?webspace="+this.options.webspace,callback:function(a){this.template=a.template,this.sandbox.emit("sulu.dropdown.template.item-clicked",a)}.bind(this)}}}),d.hasPermission(this.data,"delete")&&!l(this.data)&&(p["delete"]={options:{callback:function(){this.sandbox.emit("sulu.content.content.delete",this.data.id)}.bind(this)}}),d.hasPermission(this.data,"edit")&&(p.copyLocale={options:{title:this.sandbox.translate("toolbar.copy-locale"),callback:function(){c.startCopyLocalesOverlay.call(this).then(function(){this.load(this.data,this.options.webspace,this.options.language,!0)}.bind(this))}.bind(this)}}),this.sandbox.util.isEmpty(p)||(o.edit={options:{dropdownItems:p}}),d.hasPermission(this.data,"edit")&&(o.state={options:{disabled:l(this.data),dropdownItems:{statePublish:{},stateTest:{}}}}),b={noBack:l(this.data),tabs:{url:e},title:function(){return this.data.title}.bind(this),toolbar:{languageChanger:{data:h,preSelected:this.options.language},buttons:o}}}return b},layout:function(){return"column"===this.options.display?{}:{navigation:{collapsed:!0},content:{shrinkable:this.options.preview?!0:!1},sidebar:this.options.preview?"max":!1}}}});
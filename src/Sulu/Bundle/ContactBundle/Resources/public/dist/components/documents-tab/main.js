define(["widget-groups","services/sulucontact/account-manager","services/sulucontact/contact-manager"],function(a,b,c){"use strict";return{view:!0,layout:function(){return{content:{width:"fixed"},sidebar:{width:"max",cssClasses:"sidebar-padding-50"}}},templates:["/admin/contact/template/basic/documents"],initialize:function(){this.manager="contact"===this.options.type?c:b,this.form="#documents-form",this.newSelections=[],this.removedSelections=[],this.manager.loadOrNew(this.options.id).then(function(b){this.data=b,this.currentSelection=this.getPropertyFromArrayOfObject(this.data.medias,"id"),this.sandbox.emit("sulu.tab.dirty"),this.render(),this.data&&this.data.id&&("contact"===this.options.type&&a.exists("contact-detail")?this.initSidebar("/admin/widget-groups/contact-detail?contact=",this.data.id):"account"===this.options.type&&a.exists("account-detail")&&this.initSidebar("/admin/widget-groups/account-detail?account=",this.data.id))}.bind(this))},getPropertyFromArrayOfObject:function(a,b){if("array"===this.sandbox.util.typeOf(a)&&a.length>0&&"object"===this.sandbox.util.typeOf(a[0])){var c=[];return this.sandbox.util.foreach(a,function(a){c.push(a[b])}.bind(this)),c}return a},initSidebar:function(a,b){this.sandbox.emit("sulu.sidebar.set-widget",a+b)},render:function(){var a=this.data;this.html(this.renderTemplate(this.templates[0])),this.initForm(a),this.bindCustomEvents()},initForm:function(a){var b=this.sandbox.form.create(this.form);b.initialized.then(function(){this.setForm(a)}.bind(this))},setForm:function(a){this.sandbox.form.setData(this.form,a).fail(function(a){this.sandbox.logger.error("An error occured when setting data!",a)}.bind(this))},bindCustomEvents:function(){this.sandbox.on("sulu.tab.save",this.save.bind(this)),this.sandbox.on("sulu.media-selection.document-selection.data-changed",function(){this.sandbox.emit("sulu.tab.dirty")},this),this.sandbox.on("sulu.contacts.contacts.medias.removed",this.resetAndRemoveFromCurrent.bind(this)),this.sandbox.on("sulu.contacts.accounts.medias.removed",this.resetAndRemoveFromCurrent.bind(this)),this.sandbox.on("sulu.contacts.accounts.medias.saved",this.resetAndAddToCurrent.bind(this)),this.sandbox.on("sulu.contacts.contacts.medias.saved",this.resetAndAddToCurrent.bind(this)),this.sandbox.on("sulu.media-selection.document-selection.record-selected",this.selectItem.bind(this)),this.sandbox.on("sulu.media-selection.document-selection.record-deselected",this.deselectItem.bind(this)),this.sandbox.on("husky.dropzone.media-selection-document-selection.files-added",this.addedItems.bind(this))},resetAndRemoveFromCurrent:function(a){this.newSelections=[],this.removedSelections=[],this.sandbox.util.foreach(a,function(a){this.currentSelection.indexOf(a)>-1&&this.currentSelection.splice(this.currentSelection.indexOf(a),1)}.bind(this)),this.setForm(this.currentSelection)},resetAndAddToCurrent:function(a){this.newSelections=[],this.removedSelections=[],this.currentSelection=this.currentSelection.concat(a),this.setForm(this.currentSelection)},deselectItem:function(a){this.currentSelection.indexOf(a)>-1&&-1===this.removedSelections.indexOf(a)&&this.removedSelections.push(a),this.newSelections.indexOf(a)>-1&&this.newSelections.splice(this.newSelections.indexOf(a),1)},addedItems:function(a){this.sandbox.util.foreach(a,function(a){a&&a.id&&this.selectItem(a.id)}.bind(this))},selectItem:function(a){this.currentSelection.indexOf(a)<0&&this.newSelections.indexOf(a)<0&&this.newSelections.push(a),this.removedSelections.indexOf(a)>-1&&this.removedSelections.splice(this.removedSelections.indexOf(a),1)},save:function(){this.sandbox.form.validate(this.form)&&this.manager.saveDocuments(this.data.id,this.newSelections,this.removedSelections).then(function(a){this.sandbox.emit("sulu.tab.saved",a)}.bind(this))}}});
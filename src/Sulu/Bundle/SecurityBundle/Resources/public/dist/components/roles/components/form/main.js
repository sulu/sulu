define(["config"],function(a){"use strict";var b,c=a.get("sulusecurity.permissions"),d=a.get("sulusecurity.permission_titles"),e="#matrix-container",f="#matrix",g="#role-form";return{name:"Sulu Security Role Form",layout:{},templates:["/admin/security/template/role/form"],initialize:function(){this.saved=!0,b=this.options.data.permissions,this.sandbox.on("husky.select.system.initialize",function(){this.initializeMatrix(this.sandbox.dom.data("#system","selection-values")[0]),this.initializeValidation(),this.bindDOMEvents(),this.bindCustomEvents(),this.setHeaderBar(!0),this.listenForChange()}.bind(this)),this.render()},bindDOMEvents:function(){this.sandbox.dom.on("#select-all","click",function(){this.sandbox.emit("husky.matrix.set-all")}.bind(this))},bindCustomEvents:function(){this.sandbox.on("husky.matrix.changed",function(a){this.changePermission(a)}.bind(this)),this.sandbox.on("sulu.toolbar.save",function(a){this.save(a)}.bind(this)),this.sandbox.on("sulu.toolbar.delete",function(){this.sandbox.emit("sulu.role.delete",this.sandbox.dom.val("#id"))}.bind(this)),this.sandbox.on("sulu.role.saved",function(a){this.options.data.id=a,this.setHeaderBar(!0)},this),this.sandbox.on("sulu.header.back",function(){this.sandbox.emit("sulu.roles.list")},this),this.sandbox.on("husky.select.system.selected.item",function(){this.initializeMatrix(this.sandbox.dom.data("#system","selection-values")[0])}.bind(this))},initializeValidation:function(){this.sandbox.form.create(g)},initializeMatrices:function(a){var g,h,i=this.sandbox.dom.createElement('<div id="matrix" class="loading"/>'),j=function(a){var d,e=!1;g.push(a.split(".").splice(2).join(".")),b.forEach(function(b){b.context===a&&(e=!0,d=h.push([])-1,c.forEach(function(a){h[d].push(b.permissions[a.value])}))}),e||h.push([])};this.sandbox.stop(f),this.sandbox.dom.append(e,i),this.sandbox.util.ajax({url:"/admin/contexts?system="+a}).done(function(a){for(var b in a)a.hasOwnProperty(b)&&(g=[],h=[],a[b].forEach(j),this.sandbox.start([{name:"matrix@husky",options:{el:f,captions:{general:b,type:this.sandbox.translate("security.roles.section"),horizontal:this.sandbox.translate("security.roles.permissions"),all:this.sandbox.translate("security.roles.all"),none:this.sandbox.translate("security.roles.none"),vertical:g},values:{vertical:a[b],horizontal:c,titles:this.sandbox.translateArray(d)},data:h}}]),this.sandbox.dom.removeClass(i,"loading"))}.bind(this))},changePermission:function(a){"string"==typeof a.value?this.setPermission(a.section,a.value,a.activated):this.sandbox.dom.each(a.value,function(b,c){this.setPermission(a.section,c.value,a.activated)}.bind(this)),a.activated||this.sandbox.dom.attr("#god",{checked:!1})},setPermission:function(a,c,d){var e=this.getContextKey(a);b[e]?b[e].permissions[c]=d:(b[e]={},b[e].context=a,b[e].permissions={},b[e].permissions[c]=d)},getContextKey:function(a){var c=b.length;return b.forEach(function(b,d){b.context===a&&(c=d)}),c},save:function(a){if(this.sandbox.form.validate(g)){var c={id:this.sandbox.dom.val("#id"),name:this.sandbox.dom.val("#name"),system:this.sandbox.dom.data("#system","selection-values")[0],permissions:b};this.options.data=this.sandbox.util.extend(!0,{},this.options.data,c),this.sandbox.emit("sulu.roles.save",c,a)}},render:function(){this.$el.html(this.renderTemplate("/admin/security/template/role/form",{data:this.options.data})),this.sandbox.start(this.$el)},setHeaderBar:function(a){a!==this.saved&&(a?this.sandbox.emit("sulu.header.toolbar.item.disable","save",!0):this.sandbox.emit("sulu.header.toolbar.item.enable","save",!1)),this.saved=a},listenForChange:function(){this.sandbox.dom.on("#role-form","change",function(){this.setHeaderBar(!1)}.bind(this),"select, input"),this.sandbox.dom.on("#role-form","keyup",function(){this.setHeaderBar(!1)}.bind(this),"input"),this.sandbox.on("husky.matrix.changed",function(){this.setHeaderBar(!1)}.bind(this)),this.sandbox.on("husky.select.system.selected.item",function(a){this.setHeaderBar(!1)}.bind(this)),this.sandbox.on("husky.select.security-type.selected.item",function(a){this.setHeaderBar(!1)}.bind(this))}}});

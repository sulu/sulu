define(["sulumedia/collection/collections"],function(a){"use strict";var b={visibleItems:999,instanceName:null,url:"",idsParameter:"ids",preselected:{ids:[],displayOption:"top",config:{}},idKey:"id",titleKey:"title",thumbnailKey:"thumbnails",thumbnailSize:"50x50",resultKey:"media",positionSelectedClass:"selected",hidePositionElement:!1,translations:{noMediaSelected:"media-selection.nomedia-selected",addImages:"media-selection.add-images",choose:"public.choose",collections:"media-selection.collections",visible:"public.visible",of:"public.of"}},c={ids:[],displayOption:"top",config:{}},d="sulu.media-selection.",e=function(){return i.call(this,"input-retrieved")},f=function(){return i.call(this,"data-changed")},g=function(){return i.call(this,"data-request")},h=function(){return i.call(this,"data-retrieved")},i=function(a){return d+(this.options.instanceName?this.options.instanceName+".":"")+a},j={skeleton:function(a,b){return['<div class="white-box form-element" id="',a.ids.container,'">','   <div class="header">','       <span class="fa-plus-circle icon left action" id="',a.ids.addButton,'"></span>','       <div class="position ',b,'">','<div class="husky-position" id="',a.ids.displayOption,'">','    <div class="top left" data-position="leftTop"></div>','    <div class="top middle" data-position="top"></div>','    <div class="top right" data-position="rightTop"></div>','    <div class="middle left" data-position="left"></div>','    <div class="middle middle inactive"></div>','    <div class="middle right" data-position="right"></div>','    <div class="bottom left" data-position="leftBottom"></div>','    <div class="bottom middle" data-position="bottom"></div>','    <div class="bottom right" data-position="rightBottom"></div>',"</div>","       </div>",'       <span class="fa-cog icon right border" id="',a.ids.configButton,'" style="display:none"></span>',"   </div>",'   <div class="content" id="',a.ids.content,'"></div>',"</div>"].join("")},noContent:function(a){return['<div class="no-content">','   <span class="fa-coffee icon"></span>','   <div class="text">',a,"</div>","</div>"].join("")},addTab:function(a,b){return['<div id="',a.ids.chooseTab,'">','   <div class="heading">',"       <h3>",b,"</h3>","   </div>",'   <div id="',a.ids.gridGroup,'"/>','   <div class="overlay-loader" id="',a.ids.loader,'"></div>',"</div>"].join("")},contentItem:function(a,b,c,d){return['<li data-id="',a,'">','   <span class="num">',b,"</span>",'   <img src="',d,'"/>','   <span class="value">',c,"</span>",'   <span class="fa-times remove"></span>',"</li>"].join("")}},k=function(a){return"#"+this.options.ids[a]},l=function(){if(this.collections=new a,this.options.ids={container:"media-selection-"+this.options.instanceName+"-container",addButton:"media-selection-"+this.options.instanceName+"-add",configButton:"media-selection-"+this.options.instanceName+"-config",displayOption:"media-selection-"+this.options.instanceName+"-display-option",content:"media-selection-"+this.options.instanceName+"-content",chooseTab:"media-selection-"+this.options.instanceName+"-choose-tab",gridGroup:"media-selection-"+this.options.instanceName+"-grid-group",loader:"media-selection-"+this.options.instanceName+"-loader"},this.options.hidePositionElement?this.sandbox.dom.html(this.$el,j.skeleton(this.options,"hidden")):this.sandbox.dom.html(this.$el,j.skeleton(this.options,"")),this.$container=this.sandbox.dom.find(k.call(this,"container"),this.$el),this.$content=this.sandbox.dom.find(k.call(this,"content"),this.$el),this.$addButton=this.sandbox.dom.find(k.call(this,"addButton"),this.$el),this.$configButton=this.sandbox.dom.find(k.call(this,"configButton"),this.$el),this.sandbox.dom.data(this.$el,"media-selection")){var b=this.sandbox.util.extend(!0,{},c,this.sandbox.dom.data(this.$el,"media-selection"));A.call(this,b)}else A.call(this,this.options.preselected);m.call(this),p.call(this),this.itemsVisible=this.options.visibleItems,this.URI={str:"",hasChanged:!1},B.call(this),D.call(this),v.call(this),z.call(this),q.call(this)},m=function(){var a=this.sandbox.translate(this.options.translations.noMediaSelected);this.sandbox.dom.html(this.$content,j.noContent(a))},n=function(){var a=this.$find(k.call(this,"loader"));a.length&&this.sandbox.start([{name:"loader@husky",options:{el:a,size:"100px",color:"#cccccc"}}])},o=function(){this.sandbox.stop(k.call(this,"loader"))},p=function(){this.sandbox.on("husky.tabs.overlaymedia-selection."+this.options.instanceName+".add.initialized",function(){n.call(this),this.collections.fetch({success:function(a){o.call(this),this.sandbox.start([{name:"grid-group@suluadmin",options:{data:a.toJSON(),el:this.sandbox.dom.find(k.call(this,"gridGroup")),instanceName:this.options.instanceName,gridUrl:"/admin/api/media?"+(""!=this.options.types?"types="+this.options.types+"&":"")+"collection=",preselected:this.data.ids,resultKey:this.options.resultKey,dataGridOptions:{view:"table",resizeListeners:!1,viewOptions:{table:{excludeFields:["id"],showHead:!1,cssClass:"minimal"}},pagination:!1,matchings:[{name:"id"},{name:"thumbnails",translation:"thumbnails",type:"thumbnails"},{name:"title",translation:"title"}]}}}])}.bind(this)})}.bind(this)),this.sandbox.on(e.call(this),function(){B.call(this),z.call(this)}.bind(this)),this.sandbox.on(h.call(this),function(){t.call(this)}.bind(this)),this.sandbox.on("sulu.grid-group."+this.options.instanceName+".height-changed",function(){this.sandbox.emit("husky.overlay.media-selection."+this.options.instanceName+".add.set-position")}.bind(this)),this.sandbox.on("sulu.grid-group."+this.options.instanceName+".initialized",function(){this.sandbox.emit("husky.overlay.media-selection."+this.options.instanceName+".add.set-position")}.bind(this))},q=function(){this.sandbox.dom.on(k.call(this,"displayOption")+" > div","click",C.bind(this)),this.sandbox.dom.on(k.call(this,"content"),"click",r.bind(this),"li .remove")},r=function(a){var b=this.sandbox.dom.parents(a.currentTarget,"li"),c=this.sandbox.dom.data(b,"id");this.sandbox.dom.remove(b),s.call(this,c),this.data.ids.splice(this.data.ids.indexOf(c),1),this.itemsVisible=this.options.visibleItems,y.call(this),0===this.items.length?m.call(this):u.call(this),this.sandbox.emit(f.call(this),this.data,this.$el)},s=function(a){for(var b=-1,c=this.items.length;++b<c;)if(this.items[b].id===a)return this.items.splice(b,1),!0;return!1},t=function(){if(0!==this.items.length){for(var a,b=this.sandbox.dom.createElement('<ul class="items-list"/>'),c=-1,d=this.items.length;++c<d&&c<this.itemsVisible;)a=this.items[c][this.options.thumbnailKey][this.options.thumbnailSize],this.sandbox.dom.append(b,j.contentItem(this.items[c][this.options.idKey],c+1,this.items[c][this.options.titleKey],a));this.sandbox.dom.html(this.$content,b),u.call(this)}else m.call(this),y.call(this)},u=function(){this.itemsVisible=this.items.length<this.itemsVisible?this.items.length:this.itemsVisible,(null===this.$footer||void 0===this.$footer)&&(this.$footer=this.sandbox.dom.createElement('<div class="footer"/>')),this.sandbox.dom.html(this.$footer,["<span>","<strong>"+this.itemsVisible+" </strong>",this.sandbox.translate(this.options.translations.of)," ","<strong>"+this.items.length+" </strong>",this.sandbox.translate(this.options.translations.visible),"</span>"].join("")),this.sandbox.dom.append(this.$container,this.$footer)},v=function(){var a=j.addTab(this.options,this.sandbox.translate(this.options.translations.collections)),b=this.sandbox.dom.createElement("<div/>");this.sandbox.dom.append(this.$el,b),this.sandbox.start([{name:"overlay@husky",options:{triggerEl:this.$addButton,cssClass:"media-selection-overlay",el:b,container:this.$el,draggable:!1,instanceName:"media-selection."+this.options.instanceName+".add",skin:"medium",slides:[{title:this.sandbox.translate(this.options.translations.addImages),okCallback:w.bind(this),cssClass:"media-selection-overlay-add",tabs:[{title:this.sandbox.translate(this.options.translations.choose),data:a}]}]}}])},w=function(){var a=this.sandbox.data.deferred();this.sandbox.emit("sulu.grid-group."+this.options.instanceName+".get-selected-ids",function(b){A.call(this,{ids:b}),a.resolve()}.bind(this)),a.then(function(){this.sandbox.emit(e.call(this))}.bind(this))},x=function(){y.call(this);var a=this.sandbox.dom.createElement('<div class="loader"/>');this.sandbox.dom.html(this.$content,a),this.sandbox.start([{name:"loader@husky",options:{el:a,size:"100px",color:"#e4e4e4"}}])},y=function(){null!==this.$footer&&this.sandbox.dom.remove(this.$footer)},z=function(){this.URI.hasChanged===!0&&(this.sandbox.emit(g.call(this)),x.call(this),this.itemsVisible=this.options.visibleItems,this.sandbox.util.load(this.URI.str).then(function(a){this.items=a._embedded[this.options.resultKey],this.sandbox.emit(h.call(this))}.bind(this)).then(function(a){this.sandbox.logger.log(a)}.bind(this)))},A=function(a){for(var b in a)a.hasOwnProperty(b)&&(this.data[b]=a[b]);this.sandbox.dom.data(this.$el,"media-selection",this.data)},B=function(){var a=-1===this.options.url.indexOf("?")?"?":"&",b=[this.options.url,a,this.options.idsParameter,"=",(this.data.ids||[]).join(",")].join("");b!==this.URI.str?(""!==this.URI.str&&this.sandbox.emit(f.call(this),this.data,this.$el),this.URI.str=b,this.URI.hasChanged=!0):this.URI.hasChanged=!1},C=function(a){this.sandbox.dom.removeClass(this.sandbox.dom.find("."+this.options.positionSelectedClass,k.call(this,"displayOption")),this.options.positionSelectedClass),this.sandbox.dom.addClass(a.currentTarget,this.options.positionSelectedClass),A.call(this,{displayOption:this.sandbox.dom.data(a.currentTarget,"position")}),this.sandbox.emit(f.call(this),this.data,this.$el)},D=function(){var a=this.$find(k.call(this,"displayOption")),b=this.sandbox.dom.find('[data-position="'+this.data.displayOption+'"]',a);b.length&&this.sandbox.dom.addClass(b,this.options.positionSelectedClass)};return{historyClosed:!0,initialize:function(){this.options=this.sandbox.util.extend({},b,this.options),this.data={},l.call(this)}}});
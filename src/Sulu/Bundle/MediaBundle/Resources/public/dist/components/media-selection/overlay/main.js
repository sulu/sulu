define(["underscore","config","services/sulumedia/user-settings-manager","text!./skeleton.html"],function(a,b,c,d){"use strict";var e=[{name:"id",translation:"public.id",disabled:!0,"default":!1,sortable:!0},{name:"thumbnails",translation:"media.media.thumbnails",disabled:!1,"default":!0,sortable:!0,type:"thumbnails"},{name:"title",translation:"public.title",disabled:!1,"default":!1,sortable:!0,type:"title"},{name:"size",translation:"media.media.size",disabled:!1,"default":!0,sortable:!0,type:"bytes"}];return{defaults:{options:{preselected:[],singleSelect:!1,removeable:!0,instanceName:null,types:null,removeOnClose:!1,openOnStart:!1,saveCallback:function(a){},removeCallback:function(){}},templates:{skeleton:d,uploadUrl:"/admin/api/media?collection=<%= id %>&locale=<%= locale %><% if (!!types) {%>&types=<%= types %><% } %>"},translations:{title:"sulu-media.selection.overlay.title",save:"sulu-media.selection.overlay.save",remove:"public.remove",uploadInfo:"media-selection.list-toolbar.upload-info",selectedTitle:"sulu-media.selection.overlay.selected-title",allMedias:"media-selection.overlay.all-medias",noData:"navigation.media.collections.empty",navigationTitle:"navigation.media.collections",search:"navigation.media.collections.search"}},events:{names:{setItems:{postFix:"set-items",type:"on"},open:{postFix:"open",type:"on"}},namespace:"sulu.media-selection-overlay."},loadedItems:{},initialize:function(){this.initializeDialog(),this.bindCustomEvents()},bindCustomEvents:function(){this.sandbox.on("husky.data-navigation."+this.options.instanceName+".selected",this.dataNavigationSelectHandler.bind(this)),this.options.removeOnClose&&this.sandbox.on("husky.overlay."+this.options.instanceName+".closed",function(){this.sandbox.stop()}.bind(this)),this.sandbox.on("husky.dropzone."+this.options.instanceName+".files-added",function(a){return this.sandbox.emit("sulu.labels.success.show","labels.success.media-upload-desc","labels.success"),this.options.singleSelect?(this.setItems([a[0]]),this.save(),this.sandbox.emit("husky.overlay."+this.options.instanceName+".close")):void this.addFilesToDatagrid.call(this,a)}.bind(this)),this.sandbox.on("sulu.toolbar."+this.options.instanceName+".add",function(){this.sandbox.emit("husky.dropzone."+this.options.instanceName+".open-data-source")}.bind(this)),this.sandbox.on("husky.overlay.dropzone-"+this.options.instanceName+".opened",function(){this.$el.find(".single-media-selection").addClass("dropzone-overlay-opened")}.bind(this)),this.sandbox.on("husky.overlay.dropzone-"+this.options.instanceName+".closed",function(){this.$el.find(".single-media-selection").removeClass("dropzone-overlay-opened")}.bind(this)),this.sandbox.on("sulu.toolbar.change.table",function(){c.setMediaListView("table"),c.setMediaListPagination("dropdown"),this.sandbox.emit("husky.datagrid."+this.options.instanceName+".change",1,c.getDropdownPageSize(),"table",[],"dropdown")}.bind(this)),this.sandbox.on("sulu.toolbar.change.masonry",function(){c.setMediaListView("datagrid/decorators/masonry-view"),c.setMediaListPagination("infinite-scroll"),this.sandbox.emit("husky.datagrid."+this.options.instanceName+".change",1,c.getInfinityPageSize(),"datagrid/decorators/masonry-view",null,"infinite-scroll")}.bind(this)),this.events.setItems(this.setItems.bind(this)),this.events.open(function(){this.sandbox.emit("husky.overlay."+this.options.instanceName+".open")}.bind(this)),this.sandbox.on("husky.datagrid."+this.options.instanceName+".item.select",function(a,b){this.addItem(b)&&this.sandbox.emit("husky.datagrid."+this.options.instanceName+"-selected.record.add",b)}.bind(this)),this.sandbox.on("husky.datagrid."+this.options.instanceName+".item.deselect",function(a){this.removeItem(a),this.sandbox.emit("husky.datagrid."+this.options.instanceName+"-selected.record.remove",a)}.bind(this)),this.sandbox.on("husky.datagrid."+this.options.instanceName+".loaded",function(b){a.each(b._embedded.media,function(a){this.loadedItems[a.id]=a}.bind(this))}.bind(this))},save:function(){this.options.saveCallback(this.getData())},getData:function(){return a.map(this.items,function(a){return this.loadedItems&&this.loadedItems[a.id]?this.loadedItems[a.id]:a}.bind(this))},setItems:function(b){this.items=b;var c=a.map(this.items,function(a){return parseInt(a.id)});this.sandbox.emit("husky.datagrid."+this.options.instanceName+".selected.update",c),this.sandbox.emit("husky.datagrid."+this.options.instanceName+"-selected.url.update",{ids:c.join(","),limit:c.length})},addItem:function(a){return this.has(a.id)?!1:(this.items.push(a),!0)},removeItem:function(b){this.items=a.filter(this.items,function(a){return a.id!==b})},has:function(b){return!!a.filter(this.items,function(a){return a.id===b}).length},dataNavigationSelectHandler:function(a){var b,c=this.sandbox.translate("media-selection.overlay.all-medias");a?(b=a.id,c=a.title,this.sandbox.emit("husky.toolbar."+this.options.instanceName+".item.show","add"),this.sandbox.emit("husky.dropzone."+this.options.instanceName+".enable"),this.hideSelected()):(this.sandbox.emit("husky.toolbar."+this.options.instanceName+".item.hide","add"),this.sandbox.emit("husky.dropzone."+this.options.instanceName+".disable"),this.showSelected()),this.sandbox.emit("husky.datagrid."+this.options.instanceName+".url.update",{collection:b,page:1}),this.changeUploadCollection(b),this.$el.find(".list-title").text(c)},hideSelected:function(){this.$el.find(".selected-container").hide(),this.sandbox.emit("husky.datagrid."+this.options.instanceName+"-selected.masonry.refresh")},showSelected:function(){this.$el.find(".selected-container").show(),this.sandbox.emit("husky.datagrid."+this.options.instanceName+"-selected.masonry.refresh")},changeUploadCollection:function(a){this.sandbox.emit("husky.dropzone."+this.options.instanceName+".change-url",this.templates.uploadUrl({id:a,locale:this.options.locale,types:this.options.types}))},addFilesToDatagrid:function(a){for(var b=-1,c=a.length;++b<c;)a[b].selected=!0;this.sandbox.emit("husky.datagrid."+this.options.instanceName+".records.add",a),this.sandbox.emit("husky.data-navigation."+this.options.instanceName+".collections.reload")},initializeDialog:function(){var a=this.sandbox.dom.createElement('<div class="overlay-container"/>');this.sandbox.dom.append(this.$el,a);var b=[{type:"cancel",align:"left"}];this.options.removeable&&b.push({text:this.translations.remove,align:"center",classes:"just-text",callback:function(){this.options.removeCallback(),this.sandbox.emit("husky.overlay."+this.options.instanceName+".close")}.bind(this)}),this.options.singleSelect||b.push({type:"ok",text:this.translations.save,align:"right"}),this.sandbox.start([{name:"overlay@husky",options:{openOnStart:this.options.openOnStart,removeOnClose:this.options.removeOnClose,el:a,container:this.$el,skin:"wide",cssClass:"single-media-selection",instanceName:this.options.instanceName,slides:[{title:this.translations.title,data:this.templates.skeleton({title:this.translations.allMedias,selectedTitle:this.translations.selectedTitle}),buttons:b,okCallback:function(){this.save()}.bind(this)}]}}]).then(function(){return this.setItems(this.options.preselected),this.options.singleSelect?this.initializeFormComponents():void this.sandbox.once("husky.overlay."+this.options.instanceName+".opened",function(){this.initializeFormComponents()}.bind(this))}.bind(this))},initializeFormComponents:function(){if(this.sandbox.start([{name:"data-navigation@husky",options:{el:this.$el.find(".navigation-container"),resultKey:"collections",showAddButton:!1,instanceName:this.options.instanceName,rootUrl:"/admin/api/collections?sortBy=title",url:"/admin/api/collections?sortBy=title",nameKey:"title",globalEvents:!1,translates:{noData:this.translations.noData,title:this.translations.navigationTitle,addButton:"",search:this.translations.search}}},{name:"dropzone@husky",options:{el:this.$el.find(".dropzone-container"),maxFilesize:b.get("sulu-media").maxFilesize,url:"/admin/api/media?locale="+this.options.locale,method:"POST",paramName:"fileVersion",instanceName:this.options.instanceName,dropzoneEnabled:!1,cancelUploadOnOverlayClick:!0}}]),this.items.length||!this.options.singleSelect){var d=a.map(this.items,function(a){return a.id});this.sandbox.start([{name:"datagrid@husky",options:{el:this.$el.find(".selected-datagrid-container"),url:["/admin/api/media?locale=",this.options.locale,"&fields=id,thumbnails,title,size","&orderBy=media.created&orderSort=desc&ids=",d.join(","),"&limit=",d.length].join(""),matchings:e,view:"datagrid/decorators/masonry-view",resultKey:"media",instanceName:this.options.instanceName+"-selected",viewSpacingBottom:180,selectedCounter:!1,pagination:!1,viewOptions:{"datagrid/decorators/masonry-view":{selectable:!1,locale:this.options.locale}}}}]),this.sandbox.once("husky.datagrid."+this.options.instanceName+"-selected.loaded",function(a){return this.options.singleSelect&&0===a.total?this.$el.find(".selected-container").remove():void this.showSelected()}.bind(this))}this.sandbox.sulu.initListToolbarAndList.call(this,"mediaOverlay",e,{el:this.$el.find(".list-toolbar-container"),showTitleAsTooltip:!1,instanceName:this.options.instanceName,hasSearch:!1,template:this.sandbox.sulu.buttons.get({add:{options:{id:"add",title:this.translations.uploadInfo,hidden:!0,callback:function(){this.sandbox.emit("husky.dropzone."+this.options.instanceName+".open-data-source")}.bind(this)}},mediaDecoratorDropdown:{options:{id:"change",dropdownOptions:{markSelected:!0}}}})},{el:this.$el.find(".list-datagrid-container"),url:["/admin/api/media?locale=",this.options.locale,"&orderBy=media.created&orderSort=desc"].join(""),view:c.getMediaListView(),pagination:c.getMediaListPagination(),resultKey:"media",instanceName:this.options.instanceName,viewSpacingBottom:180,selectedCounter:!1,preselected:a.map(this.items,function(a){return parseInt(a.id)}),actionCallback:this.options.singleSelect?function(a,b){this.setItems([b]),this.save()}.bind(this):null,viewOptions:{table:{actionIcon:"check",actionIconColumn:this.options.singleSelect?"title":null,selectItem:this.options.singleSelect?!1:{type:"checkbox",inFirstCell:!1},badges:[{column:"title",callback:function(a,b){return a.locale!==this.options.locale?(b.title=a.locale,b):void 0}.bind(this)}]},"datagrid/decorators/masonry-view":{selectable:!this.options.singleSelect,locale:this.options.locale,badges:[{column:"title",callback:function(a,b){return a.locale!==this.options.locale?(b.title=a.locale,b):void 0}.bind(this)}]}},paginationOptions:{"infinite-scroll":{reachedBottomMessage:"public.reached-list-end",scrollContainer:".list-container",scrollOffset:500}}})}}});
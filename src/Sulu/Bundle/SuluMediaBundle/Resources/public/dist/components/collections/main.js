define(["sulumedia/collection/collections","sulumedia/collection/medias","sulumedia/model/collection","sulumedia/model/media"],function(a,b,c,d){"use strict";var e="sulu.media.collections.",f=function(){return r.call(this,"list")},g=function(){return r.call(this,"delete-media")},h=function(){return r.call(this,"delete-collection")},i=function(){return r.call(this,"media-deleted")},j=function(){return r.call(this,"collection-deleted")},k=function(){return r.call(this,"media-saved")},l=function(){return r.call(this,"edit-media")},m=function(){return r.call(this,"save-media")},n=function(){return r.call(this,"save-collection")},o=function(){return r.call(this,"collection-changed")},p=function(){return r.call(this,"collection-edit")},q=function(){return r.call(this,"collection-list")},r=function(a){return e+a};return{initialize:function(){if(this.collections=new a,this.medias=new b,this.bindCustomEvents(),"list"===this.options.display)this.renderList();else if("files"===this.options.display)this.renderCollectionEdit({activeTab:"files"});else{if("settings"!==this.options.display)throw"display type wrong";this.renderCollectionEdit({activeTab:"settings"})}this.startMediaEdit()},getMediaModel:function(a){if(this.medias.get(a))return this.medias.get(a);var b=new d;return a&&b.set({id:a}),this.medias.push(b),b},getCollectionModel:function(a){if(this.collections.get(a))return this.collections.get(a);var b=new c;return a&&b.set({id:a}),this.collections.push(b),b},bindCustomEvents:function(){this.sandbox.on(f.call(this),function(a){this.sandbox.emit("sulu.router.navigate","media/collections",a?!1:!0,!0)},this),this.sandbox.on(g.call(this),this.deleteMedia.bind(this)),this.sandbox.on(h.call(this),this.deleteCollection.bind(this)),this.sandbox.on(l.call(this),this.editMedia.bind(this)),this.sandbox.on(m.call(this),this.saveMedia.bind(this)),this.sandbox.on(n.call(this),this.saveCollection.bind(this)),this.sandbox.on(p.call(this),function(a,b){b=b?b:"files",this.sandbox.emit("sulu.router.navigate","media/collections/edit:"+a+"/"+b,!0,!0)}.bind(this)),this.sandbox.on(q.call(this),function(){this.sandbox.emit("sulu.router.navigate","media/collections",!0,!0)}.bind(this))},saveCollection:function(a,b){var c=this.getCollectionModel(a.id);c.set(a),c.save(null,{success:function(a){this.sandbox.emit(o.call(this),a.toJSON()),b(a.toJSON())}.bind(this),error:function(){this.sandbox.logger.log("Error while saving collection")}.bind(this)})},deleteMedia:function(a,b,c){var d,e=function(){this.sandbox.util.foreach(a,function(a){d=this.getMediaModel(a),d.destroy({success:function(){"function"==typeof b?b(a):this.sandbox.emit(i.call(this),a)}.bind(this),error:function(){this.sandbox.logger.log("Error while deleting a single media")}.bind(this)})}.bind(this))}.bind(this);c===!0?e():this.sandbox.sulu.showDeleteDialog(function(a){a===!0&&e()}.bind(this))},deleteCollection:function(a,b){this.sandbox.sulu.showDeleteDialog(function(c){if(c===!0){var d=this.getCollectionModel(a);d.destroy({success:function(){"function"==typeof b?b(a):this.sandbox.emit(j.call(this),a)}.bind(this),error:function(){this.sandbox.logger.log("Error while deleting a collection")}.bind(this)})}}.bind(this))},editMedia:function(a){this.sandbox.dom.isArray(a)?1===a.length?this.editSingleMedia(a[0]):this.editMultipleMedia(a):this.editSingleMedia(a)},editSingleMedia:function(a){var b;this.medias.get(a)?(b=this.getMediaModel(a),this.sandbox.emit("sulu.media-edit.edit",b.toJSON())):(b=this.getMediaModel(a),b.fetch({success:function(a){this.sandbox.emit("sulu.media-edit.edit",a.toJSON())}.bind(this),error:function(){this.sandbox.logger.log("Error while fetching a single media")}.bind(this)}))},editMultipleMedia:function(a){var b,c=[],d=function(){c.length===a.length&&this.sandbox.emit("sulu.media-edit.edit",c)}.bind(this);this.sandbox.util.foreach(a,function(a){this.medias.get(a)?(c.push(this.getMediaModel(a).toJSON()),d()):(b=this.getMediaModel(a),b.fetch({success:function(a){c.push(a.toJSON()),d()}.bind(this),error:function(){this.sandbox.logger.log("Error while fetching a single media")}.bind(this)}))}.bind(this))},saveMedia:function(a,b,c){if(c!==!0){var d,e=0;this.sandbox.dom.isArray(a)||(a=[a]),this.sandbox.util.foreach(a,function(c){d=this.getMediaModel(c.id),d.set(c),d.save(null,{success:function(c){this.sandbox.emit(k.call(this),c.toJSON()),++e===a.length&&b(c.toJSON())}.bind(this),error:function(){this.sandbox.logger.log("Error while saving a single media")}.bind(this)})}.bind(this))}},renderList:function(){var a=this.sandbox.dom.createElement('<div id="collections-list-container"/>');this.sandbox.dom.append(this.$el,a),this.collections.fetch({success:function(b){this.sandbox.start([{name:"collections/components/list@sulumedia",options:{el:a,data:b.toJSON()}}])}.bind(this),error:function(){this.sandbox.logger.log("Error while fetching all collections")}.bind(this)})},renderCollectionEdit:function(a){var b=this.sandbox.dom.createElement('<div id="collection-files-container"/>'),c=this.getCollectionModel(this.options.id);this.sandbox.dom.append(this.$el,b),c.fetch({success:function(c){this.sandbox.start([{name:"collections/components/collection-edit@sulumedia",options:this.sandbox.util.extend(!0,{},{el:b,activeTab:this.options.content,data:c.toJSON()},a)}])}.bind(this),error:function(){this.sandbox.logger.log("Error while fetching a single collection")}.bind(this)})},startMediaEdit:function(){var a=this.sandbox.dom.createElement("<div/>");this.sandbox.dom.append(this.$el,a),this.sandbox.start([{name:"collections/components/media-edit@sulumedia",options:{el:a}}])}}});
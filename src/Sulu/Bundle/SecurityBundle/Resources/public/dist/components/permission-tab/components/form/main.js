define(["config","sulusecurity/collections/roles"],function(a,b){"use strict";var c="/admin/api/permissions",d=a.get("sulusecurity.permissions").slice(0,-1),e="#permission-loader",f="#matrix-container",g="#matrix",h={id:null,type:null,securityContext:null,permissions:{}},i=function(){this.sandbox.on("husky.matrix.changed",l.bind(this)),this.sandbox.on("sulu.permission-tab.save",o.bind(this))},j=function(){this.$el.html(this.renderTemplate("/admin/security/template/permission-tab/form")),this.sandbox.start([{name:"loader@husky",options:{el:this.$find(e),size:"100px",color:"#cccccc"}}])},k=function(){var a=this.sandbox.dom.createElement('<div id="matrix"/>');this.sandbox.dom.append(f,a);var i=new b;this.sandbox.data.when(i.fetch(),this.sandbox.util.ajax({url:[c,"?type=",h.type,"&id=",h.id].join("")})).done(function(a,b){i=i.toJSON();var c=b[0],f=[],j=[],k=[],l=[];this.sandbox.util.each(i,function(a,b){var e={},g=[];if(j.push(b.name),k.push(b.id),l.push(d),this.sandbox.util.each(d,function(a,b){e[b.value]=!1}.bind(this)),c.permissions.hasOwnProperty(b.id))this.sandbox.util.each(c.permissions[b.id],function(a,b){m(e,g,a,b)});else{var i=q.call(this,this.options.securityContext,b);this.sandbox.util.each(i,function(a,b){m(e,g,a,b)})}h.permissions[b.id]=e,f[a]=g}.bind(this)),this.sandbox.start([{name:"matrix@husky",options:{el:g,captions:{type:this.sandbox.translate("security.roles"),horizontal:this.sandbox.translate("security.roles.permissions"),all:this.sandbox.translate("security.roles.all"),none:this.sandbox.translate("security.roles.none"),vertical:j},values:{vertical:k,horizontal:l},data:f}}]),this.$find(e).hide()}.bind(this)),this.sandbox.emit("husky.permission-form.loaded")},l=function(a){"string"==typeof a.value?n.call(this,a.section,a.value,a.activated):this.sandbox.dom.each(a.value,function(b,c){n.call(this,a.section,c.value,a.activated)})},m=function(a,b,c,d){a.hasOwnProperty(c)&&b.push(d),a[c]=d},n=function(a,b,c){h.permissions[a][b]=c},o=function(a){this.sandbox.emit("sulu.permission-form.save",h,a)},p=function(){this.sandbox.on("husky.matrix.changed",function(){this.sandbox.emit("husky.permission-form.changed")}.bind(this))},q=function(a,b){var c=[];return this.sandbox.util.each(b.permissions,function(b,d){return d.context===a?(c=d.permissions,!1):void 0}),c};return{name:"Sulu Security Object Permission Tab",templates:["/admin/security/template/permission-tab/form"],layout:function(){return this.options.inOverlay?{extendExisting:!0}:{extendExisting:!0,content:{width:"fixed",leftSpace:!0,rightSpace:!0}}},initialize:function(){h.id=this.options.id,h.type=this.options.type,h.securityContext=this.options.securityContext,j.call(this),k.call(this),i.call(this),p.call(this)}}});
define(["config","text!sulusearch/components/search-results/main.html","text!sulusearch/components/search-results/search-results.html"],function(a,b,c){"use strict";var d={instanceName:"",searchUrl:"/admin/search",enabledCategoriesUrl:"/admin/search/categories",pageLimit:20},e=function(a){return"sulu.search-results."+(this.options.instanceName?this.options.instanceName+".":"")+a},f=function(){return e.call(this,"initialized")};return{initialize:function(){this.options=this.sandbox.util.extend(!0,{},d,this.options),this.mainTemplate=this.sandbox.util.template(b),this.searchResultsTemplate=this.sandbox.util.template(c),this.dropDownEntries=[],this.enabledCategories=[],this.categories={},this.categoriesStore={},this.totals={},this.state={page:1,pages:1,loading:!1,hasNextPage:!0,category:"all",query:""},this.loadCategories().then(function(){this.render(),this.startInfiniteScroll(),this.bindEvents(),this.bindDomEvents(),this.sandbox.emit(f.call(this))}.bind(this))},bindEvents:function(){this.sandbox.on("sulu.data-overlay.show",this.focusInput.bind(this)),this.sandbox.on("sulu.dropdown-input."+this.dropDownInputInstance+".action",this.dropDownInputActionHandler.bind(this)),this.sandbox.on("sulu.dropdown-input."+this.dropDownInputInstance+".clear",this.dropDownInputClearHandler.bind(this)),this.sandbox.on("sulu.dropdown-input."+this.dropDownInputInstance+".change",this.dropDownInputActionHandler.bind(this))},bindDomEvents:function(){this.$el.on("click",".search-results-section li",this.openSearchEntry.bind(this))},render:function(){var a=this.mainTemplate({translate:this.sandbox.translate});this.$el.html(a),this.createSearchInput()},focusInput:function(){this.sandbox.emit("sulu.dropdown-input."+this.dropDownInputInstance+".focus")},addCategory:function(a){var b={id:a,name:this.sandbox.translate("search-overlay.category."+a+".title"),placeholder:this.sandbox.translate("search-overlay.placeholder."+a)};this.categories[a]=b,this.enabledCategories.push(b)},startInfiniteScroll:function(){var a=this.$el.find(".iscroll");this.sandbox.infiniteScroll(a,this.loadNextPage.bind(this),50)},loadCategories:function(){return this.sandbox.util.load(this.options.enabledCategoriesUrl).then(function(a){this.addCategory("all"),a.forEach(this.addCategory.bind(this))}.bind(this))},createSearchInput:function(){this.dropDownInputInstance="searchResults",this.sandbox.start([{name:"dropdown-input@sulusearch",options:{el:this.$el.find(".search-results-bar"),instanceName:this.dropDownInputInstance,preSelectedElement:"all",data:this.enabledCategories,focused:!0}}])},load:function(a){a=$.extend({q:this.state.query,page:this.state.page,limit:100},a);var b=this.options.searchUrl+"/query?"+$.param(a),c=this.state.category;return c&&"all"!==c&&(b+="&category="+c),this.sandbox.util.load(b).then(this.parse.bind(this))},loadNextPage:function(){var a=this.sandbox.data.deferred();return this.state.hasNextPage&&!this.state.loading?(this.startLoader(),this.state.page++,this.load({limit:this.options.pageLimit}).then(this.mergeResults.bind(this)).then(this.updateResults.bind(this))):(a.resolve(),a)},parse:function(b){var c,d,e=b._embedded.result||[],f={};return this.state.page=b.page,this.state.pages=b.pages,this.state.loading=!1,this.state.hasNextPage=b.page<b.pages,this.totals=b.totals,e.forEach(function(b){var e;c=b.document.category,d=this.getEntryDeepUrl(c,b.document),b.document.deepUrl=d,e=a.get("sulusearch."+c+".options")||{},f[c]?f[c].results.push(b.document):f[c]={category:c,results:[b.document],options:this.sandbox.util.extend(!0,{},{image:!0},e)}}.bind(this)),f},mergeResults:function(a){return a&&Object.keys(a).forEach(function(b){this.categoriesStore[b]?this.categoriesStore[b].results=this.categoriesStore[b].results.concat(a[b].results):this.categoriesStore[b]=a[b]}.bind(this)),this.categoriesStore},dropDownInputActionHandler:function(a){a.value&&(this.state.query=a.value,this.state.category=a.selectedElement,this.state.page=1,this.categoriesStore={},this.startLoader(),this.updateResults(),this.load().then(function(a){this.categoriesStore=a,this.updateResults(a)}.bind(this)))},dropDownInputClearHandler:function(){this.updateResults()},getEntryDeepUrl:function(a,b){var c=this.sandbox.urlManager.getUrl(a,b);return c},categoryIconMapping:{contact:"fa-user",page:"fa-file-o",snippet:"fa-file",account:"fa-university"},getTemplate:function(a){var b=null;return a&&(b=[],Object.keys(a).forEach(function(c){b.push(a[c])}.bind(this))),this.searchResultsTemplate({sections:b,categories:this.categories,totals:this.totals,categoryIconMapping:this.categoryIconMapping,translate:this.sandbox.translate})},updateResults:function(a){var b=this.getTemplate(a);this.stopLoader(),this.$el.find(".search-results").html(b)},openSearchEntry:function(a){var b=$(a.currentTarget),c=b.data("url");c&&(this.sandbox.emit("sulu.router.navigate",c),this.sandbox.emit("sulu.data-overlay.hide"))},startLoader:function(){var a=this.sandbox.dom.createElement('<div class="search-results-loader"/>');this.sandbox.dom.append(this.$el.find(".search-results-loader-container"),a),this.sandbox.start([{name:"loader@husky",options:{el:a,size:"100px",color:"#ccc"}}])},stopLoader:function(){this.sandbox.stop(".search-results-loader")}}});
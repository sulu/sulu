define(["underscore","config","services/husky/translator","text!sulucontentcss/ckeditor/internal-link-plugin.css"],function(a,b,c,d){"use strict";var e=b.get("sulu_content.link_provider.configuration"),f=function(a){if(!a.getStartElement())return null;var b=a.getStartElement(),c=b.getAscendant("sulu:link",!0);return c&&c.is("sulu:link")?{title:c.getText(),altTitle:c.getAttribute("title"),target:c.getAttribute("target"),href:c.getAttribute("href"),provider:c.getAttribute("provider")}:{title:a.getSelectedText()}},g=function(a){if(!a.getStartElement())return!1;var b=a.getStartElement(),c=b.getAscendant("sulu:link",!0);return!!c&&c.is("sulu:link")},h=function(a,b,c){var d=b.getStartElement();d&&d.is("sulu:link")||(d=a.document.createElement("sulu:link"),a.insertElement(d)),d.setAttribute("title",c.altTitle),d.setAttribute("href",c.href),d.setAttribute("target",c.target),d.setAttribute("provider",c.provider),d.setText(c.title),d.removeAttribute("sulu:validation-state"),c.published||d.setAttribute("sulu:validation-state","unpublished"),a.fire("change")},i=function(a,b){var c=f(b),d=b.getStartElement(),e=d.getAscendant("sulu:link",!0);e.remove(),a.insertText(c.title)};return function(b){return{tagName:"sulu:link",init:function(a){this.extendCkEditorDtd(),a.addCommand("internalLinkDialog",this.getInternalLinkCommand(a)),a.addCommand("removeInternalLink",this.getRemoveInternalLinkCommand(a)),a.addMenuGroup("sulu_links");var b={};for(var d in e){var h=d+"Command";a.addCommand(h,this.getInternalLinkCommand(a,d)),b[d]={label:c.translate(e[d].title),group:"sulu_links",command:h}}b.remove={label:c.translate("content.ckeditor.internal-link.remove-drop-down"),icon:"/bundles/sulucontent/img/icon_remove_link_internal.png",group:"sulu_links",command:"removeInternalLink"},a.addMenuItems(b),a.ui.add("InternalLink",CKEDITOR.UI_MENUBUTTON,{label:c.translate("content.ckeditor.internal-link"),modes:{wysiwyg:1},icon:"/bundles/sulucontent/img/icon_link_internal.png",onMenu:function(){var c={},d=g(a.getSelection()),e=f(a.getSelection());for(var h in b)d&&(e.provider||"page")!==h||(c[h]=CKEDITOR.TRISTATE_OFF),c.remove=CKEDITOR.TRISTATE_OFF;return c}}),a.contextMenu&&(this.addMenuSuluGroup(a),a.contextMenu.addListener(function(a){return a.getAscendant("sulu:link",!0)?{internalLinkItem:CKEDITOR.TRISTATE_OFF,removeInternalLinkItem:CKEDITOR.TRISTATE_OFF}:void 0}))},addMenuSuluGroup:function(a){a.addMenuGroup("suluGroup"),a.addMenuItem("internalLinkItem",{label:c.translate("content.ckeditor.internal-link.edit"),icon:"/bundles/sulucontent/img/icon_link_internal.png",command:"internalLinkDialog",group:"suluGroup"}),a.addMenuItem("removeInternalLinkItem",{label:c.translate("content.ckeditor.internal-link.remove"),icon:"/bundles/sulucontent/img/icon_remove_link_internal.png",command:"removeInternalLink",group:"suluGroup"})},getInternalLinkCommand:function(a,c){return{dialogName:"internalLinkDialog",allowedContent:"sulu:link[title,target,sulu:validation-state,!href]",requiredContent:"sulu:link[href]",exec:function(){var d=$("<div/>"),e=f(a.getSelection());$("#content").append(d),b.start([{name:"ckeditor/link@sulucontent",options:{el:d,provider:e.provider||c||"page",webspace:a.config.webspace,locale:a.config.locale,link:e,saveCallback:function(c){b.stop(d),h(a,a.getSelection(),c)},removeCallback:function(){i(a,a.getSelection())}}}])}}},getRemoveInternalLinkCommand:function(a){return{exec:function(){i(a,a.getSelection())},refresh:function(){var b=a.getSelection(),c=b.getStartElement();return c.getAscendant("sulu:link",!0)?void this.setState(CKEDITOR.TRISTATE_OFF):void this.setState(CKEDITOR.TRISTATE_DISABLED)},contextSensitive:1,startDisabled:1}},extendCkEditorDtd:function(){CKEDITOR.dtd[this.tagName]=1,CKEDITOR.dtd.body[this.tagName]=1,CKEDITOR.dtd.div[this.tagName]=1,CKEDITOR.dtd.li[this.tagName]=1,CKEDITOR.dtd.p[this.tagName]=1,CKEDITOR.dtd.$inline[this.tagName]=1,CKEDITOR.dtd.$removeEmpty[this.tagName]=1},onLoad:function(){CKEDITOR.addCss(a.template(d,{translations:{unpublished:c.translate("content.text_editor.error.unpublished"),removed:c.translate("content.text_editor.error.removed")}}))}}}});
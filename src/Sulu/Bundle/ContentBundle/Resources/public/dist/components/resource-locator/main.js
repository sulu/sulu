define(["config"],function(a){"use strict";var b={instanceName:null,url:null,historyApi:null,deleteApi:null,inputType:null,webspaceKey:null},c=function(a){if(a.hasOwnProperty("value")&&"/"===a.value)return['<div class="resource-locator">','   <span id="'+a.ids.url+'" class="grey-font">',a.url?a.url:"","</span>",'   <span id="'+a.ids.tree+'" class="grey-font"></span>',"</div>"].join("");var b=['<span class="show pointer small-font" id="'+a.ids.toggle+'">','   <span class="fa-history icon"></span>',"   <span>"+a.showHistoryText+"</span>","</span>"];return['<div class="resource-locator">','   <span id="'+a.ids.url+'" class="grey-font">',a.url?a.url:"","</span>",'   <span id="'+a.ids.tree+'" class="grey-font"></span>','   <input type="text" id="'+a.ids.input+'" class="form-element"/>',a.historyApi?b.join(""):"",'   <div class="loader" id="',a.ids.loader,'"></div>',"</div>"].join("")},d=function(a){return"#"+this.options.ids[a]},e=function(){this.options.ids={url:"resource-locator-"+this.options.instanceName+"-url",input:"resource-locator-"+this.options.instanceName+"-input",tree:"resource-locator-"+this.options.instanceName+"-tree",toggle:"resource-locator-"+this.options.instanceName+"-toggle",loader:"resource-locator-"+this.options.instanceName+"-loader"},this.options.showHistoryText=this.sandbox.translate("public.show-history"),this.sandbox.dom.html(this.$el,c(this.options)),l.call(this),j.call(this)},f=function(a){a=a.parents(".overlay-content"),this.sandbox.dom.append(a,this.sandbox.dom.createElement('<div class="loader"/>')),this.sandbox.dom.css(a.find(".resource-locator-history"),"display","none"),this.sandbox.start([{name:"loader@husky",options:{el:this.sandbox.dom.find(".loader",a),size:"16px",color:"#666666"}}])},g=function(a){a=a.parents(".overlay-content"),this.sandbox.dom.css(a.find(".resource-locator-history"),"display","block"),this.sandbox.stop(this.sandbox.dom.find(".loader",a))},h=function(){var a=this.sandbox.dom.createElement("<div/>");this.sandbox.dom.html(d.call(this,"loader"),a),this.sandbox.start([{name:"loader@husky",options:{el:a,size:"16px",color:"#666666"}}])},i=function(){this.sandbox.stop(d.call(this,"loader")+" > div")},j=function(){this.sandbox.dom.on(this.$el,"data-changed",function(a,b){l.call(this,b)}.bind(this)),this.sandbox.dom.on(d.call(this,"toggle"),"click",p.bind(this)),this.sandbox.dom.on(d.call(this,"input"),"change",m.bind(this)),this.sandbox.dom.on(d.call(this,"input"),"change",function(){this.sandbox.emit("sulu.content.changed")}.bind(this)),this.sandbox.dom.on(d.call(this,"input"),"focusout",function(){this.$el.trigger("focusout")}.bind(this)),this.sandbox.dom.on(this.$el,"click",k.bind(this),".options-delete")},k=function(a){this.sandbox.sulu.showDeleteDialog(function(b){if(b===!0){var c=this.sandbox.dom.$(a.currentTarget),d=this.sandbox.dom.parent(c),e=this.sandbox.dom.data(d,"id");f.call(this,d),this.sandbox.util.save(this.items[e]._links["delete"],"DELETE").then(function(){g.call(this,d),this.sandbox.dom.remove(d)}.bind(this)).fail(function(){g.call(this,d)})}}.bind(this),"public.delete","sulu-content.resource-locator.delete")},l=function(a){a||(a=this.sandbox.dom.data(this.$el,"value"),a||(a=""));var b,c;"leaf"===q.call(this,this.options.webspaceKey)?(b=a.split("/"),c=b.pop()):(b=[],c=a.substring(1)),this.sandbox.dom.data(this.$el,"part",c),this.sandbox.dom.val(d.call(this,"input"),c),this.sandbox.dom.html(d.call(this,"tree"),b.join("/")+"/")},m=function(){var a=this.sandbox.dom.val(d.call(this,"input")),b=this.sandbox.dom.html(d.call(this,"tree"));this.sandbox.dom.data(this.$el,"part",a),this.sandbox.dom.data(this.$el,"value",b+a)},n=function(a){if(this.items=[],a.length>0){var b=['<ul class="resource-locator-history">'];return this.sandbox.util.foreach(a,function(a){this.items[a.id]=a,b.push('<li data-id="'+a.id+'" data-path="'+a.resourceLocator+'">   <span class="url">'+this.sandbox.util.cropMiddle(a.resourceLocator,30)+'</span>   <span class="date">'+this.sandbox.date.format(a.created)+'</span>   <span class="options-delete"><i class="fa fa-trash-o pointer"></i></span></li>')}.bind(this)),b.push("</ul>"),b.join("")}return"<p>"+this.sandbox.translate("public.url-history.none")+"</p>"},o=function(a){var b=this.sandbox.dom.createElement("<div/>");this.sandbox.dom.append(this.$el,b),this.sandbox.start([{name:"overlay@husky",options:{el:b,container:b,title:this.sandbox.translate("public.url-history"),openOnStart:!0,removeOnClose:!0,instanceName:"url-history",skin:"medium",data:a}}])},p=function(){h.call(this),this.sandbox.util.load(this.options.historyApi).then(function(a){i.call(this);var b=n.call(this,a._embedded.resourcelocators);o.call(this,b)}.bind(this))},q=function(b){return this.options.inputType?this.options.inputType:a.get("sulu_content.webspace_input_types")[b]};return{historyClosed:!0,initialize:function(){this.options=this.sandbox.util.extend({},b,this.options),e.call(this)}}});
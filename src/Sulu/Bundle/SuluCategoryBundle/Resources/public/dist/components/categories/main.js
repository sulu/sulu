define(["sulucategory/model/category","sulucategory/collections/categories"],function(a,b){"use strict";var c={listContainerId:"categories-list-container",formContainerId:"categories-form-container"},d="sulu.category.categories.",e=function(){return l.call(this,"list")},f=function(){return l.call(this,"form")},g=function(){return l.call(this,"form-add")},h=function(){return l.call(this,"changed")},i=function(){return l.call(this,"save")},j=function(){return l.call(this,"delete")},k=function(){return l.call(this,"deleted")},l=function(a){return d+a};return{initialize:function(){this.categories=new b,this.locale=null,this.bindCustomEvents(),this.render()},getCategoryModel:function(b){if(this.categories.get(b))return this.categories.get(b);var c=new a;return b&&c.set({id:b}),this.categories.push(c),c},render:function(){if("list"===this.options.display)this.renderList();else{if("form"!==this.options.display)throw"display type wrong";this.renderForm()}},bindCustomEvents:function(){this.sandbox.on("sulu.header.language-changed",this.renderForm.bind(this)),this.sandbox.on(e.call(this),this.navigateToList.bind(this)),this.sandbox.on(f.call(this),this.navigateToForm.bind(this)),this.sandbox.on(g.call(this),this.navigateToAddForm.bind(this)),this.sandbox.on(i.call(this),this.saveCategory.bind(this)),this.sandbox.on(j.call(this),this.deleteCategories.bind(this))},saveCategory:function(a,b){var c=this.getCategoryModel(a.id);c.set(a),c.save(null,{success:function(a){this.sandbox.emit(h.call(this),a.toJSON()),b(a.toJSON(),!0)}.bind(this),error:function(a,c){this.sandbox.logger.log("Error while saving category"),b(c.responseJSON,!1)}.bind(this)})},deleteCategories:function(a,b,c){var d,e=0;this.sandbox.sulu.showDeleteDialog(function(f){f===!0&&this.sandbox.util.foreach(a,function(f){d=this.getCategoryModel(f),d.destroy({success:function(){"function"==typeof b?b(f):this.sandbox.emit(k.call(this),f),e++,e===a.length&&"function"==typeof c&&c()}.bind(this),error:function(){this.sandbox.logger.log("Error while deleting a single category")}.bind(this)})}.bind(this))}.bind(this))},navigateToList:function(){this.sandbox.emit("sulu.router.navigate","settings/categories",!0,!0)},navigateToForm:function(a,b){b=b?b:"details",this.sandbox.emit("sulu.router.navigate","settings/categories/edit:"+a+"/"+b,!0,!0)},navigateToAddForm:function(a,b){b=b?b:"details";var c="settings/categories/new";c=(a?c+"/"+a:c)+"/"+b,this.sandbox.emit("sulu.router.navigate",c,!0,!0)},renderList:function(){var a=this.sandbox.dom.createElement('<div id="'+c.listContainerId+'"/>');this.html(a),this.sandbox.start([{name:"categories/list@sulucategory",options:{el:a}}])},renderForm:function(a){this.sandbox.stop("#"+c.formContainerId);var b,d=function(a){this.sandbox.start([{name:"categories/form@sulucategory",options:{el:e,data:a,activeTab:this.options.content}}])}.bind(this),e=this.sandbox.dom.createElement('<div id="'+c.formContainerId+'"/>');this.html(e),b=this.getCategoryModel(this.options.id),a&&b.set({locale:a}),this.options.parent&&b.set({parent:this.options.parent}),b.get("id")?b.fetch({data:{locale:a,flat:!0},success:function(a){d(a.toJSON())}.bind(this),error:function(){this.sandbox.logger.log("Error while fetching a single category")}.bind(this)}):d(b.toJSON())}}});